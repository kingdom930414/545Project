<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="canonical" href="https://getbootstrap.com/docs/4.0/examples/dashboard/">
    
    <title>Socket.IO chat</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="https://kit.fontawesome.com/32b0047838.js" crossorigin="anonymous"></script>
    <script>
      $(function () {
        var socket = io();
        $('form').submit(function(e){
          e.preventDefault(); // prevents page reloading
          socket.emit('chat message', $('#m').val());
          $('#m').val('');
          return false;
        });
        socket.on('chat message', function(msg){
          $('#messages').append($('<li>').text(msg));
        });
      });
  </script>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: white; padding: 3px; position: fixed; bottom: 0; width: 80%; margin-top: 100px; } */
      form input { border: 1; padding: 10px; width: 70%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; } */
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
      #icon span {
        font-size: 2em; color: gray; padding: 0 0.2em;
      }
      #portrait {height: 50px;width: 50px; border-radius: 50%; border: 1px solid gray; margin: 5px;}
    </style>
    <style>
        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #map {
          height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */
        html, body {
          height: 100%;
          margin: 0;
          padding: 0;
        }
        </style>
  </head>
  <body>
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
        <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">On Campus</a>
        <!--<input class="form-control form-control-dark w-100" type="text" placeholder="Search" aria-label="Search">-->
        <ul class="navbar-nav px-3">
          <li class="nav-item text-nowrap">
            <a class="nav-link" href="#">Sign out</a>
          </li>
        </ul>
      </nav>
    
      <div class="container-fluid">
          <div class="row">
            <nav class="col-md-2 d-none d-md-block bg-light sidebar">
              <div class="sidebar-sticky">
                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                    <span>Favorite Contacts</span>
                    <a class="d-flex align-items-center text-muted" href="#">
                      <span data-feather="plus-circle"></span>
                    </a>
                  </h6>
                <ul class="nav flex-column">
                  <li class="nav-item" >
                    <img id="portrait" src="./images/portrait01.png" alt="">
                    <a class="nav-link active" href="#" style="display:inline-block">
                      <span data-feather="home"></span>
                      Tianyi Wang <span class="sr-only">(current)</span>
                    </a>
                  </li>
                  <li class="nav-item">
                    <img id="portrait"  src="./images/portrait02.png" alt="">
                    <a class="nav-link" href="#" style="display:inline-block">
                      <span data-feather="file"></span>
                      HuiXiang Xu
                    </a>
                  </li>
                  <li class="nav-item">
                    <img id="portrait"  src="./images/portrait03.jpg" alt="">
                    <a class="nav-link" href="#" style="display:inline-block">
                      <span data-feather="shopping-cart"></span>
                      Jierui Wang
                    </a>
                  </li>
                  <li class="nav-item">
                    <img id="portrait" src="./images/portrait04.jpg" alt="">
                    <a class="nav-link" href="#" style="display:inline-block">
                      <span data-feather="users"></span>
                      Yuting Shao
                    </a>
                  </li>
                  <li class="nav-item">
                    <img id="portrait"  src="./images/portrait05.png" alt="">
                    <a class="nav-link" href="#" style="display:inline-block">
                      <span data-feather="bar-chart-2"></span>
                      Huajie Xu
                    </a>
                  </li>
                  <li class="nav-item">
                    <img id="portrait" src="./images/portrait06.jpg" alt="">
                    <a class="nav-link" href="#" style="display:inline-block">
                      <span data-feather="layers"></span>
                      Xiao Zhao
                    </a>
                  </li>
                </ul>
    
                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                  <span>Group Chat</span>
                  <a class="d-flex align-items-center text-muted" href="#">
                    <span data-feather="plus-circle"></span>
                  </a>
                </h6>
                <ul class="nav flex-column mb-2">
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      <span data-feather="file-text"></span>
                      CS545 Group Chat
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      <span data-feather="file-text"></span>
                      CS513 Group Chat
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      <span data-feather="file-text"></span>
                      CS584 Group Chat
                    </a>
                  </li>
                  
                </ul>
              </div>
            </nav>
  
            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4">
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                <h2>Campus Map</h2>
                <div class="btn-toolbar mb-2 mb-md-0">
                  <div class="btn-group mr-2">
                    <button class="btn btn-sm btn-outline-secondary">Zoom In<button>
                    <button class="btn btn-sm btn-outline-secondary">Zoom Out</button>
                  </div>
                  <button class="btn btn-sm btn-outline-secondary">
                    Share Location
                  </button>
                </div>
                
              </div>
              <div style = "height: 80%;"id="map"></div>
              <h2>Let's Chat</h2>
              <div id="messages"></div>
              <br></br>
              <br></br>
              <br></br>
            <div>
                
              <form action=""> 
                  <div id = "icon">
                      <span>
                        <i class="fas fa-laugh"></i>
                        </span>
                      <span>
                        <i class="fas fa-image"></i>
                      </span>
                      <span>
                        <i class="fas fa-camera"></i>
                      </span>
                      <span>
                        <i class="fas fa-microphone-alt"></i>
                      </span>
                      <span>
                      <i class="fas fa-video"></i>
                      </span>
                      <span>
                        <i class="fas fa-map-marker-alt"></i>
                      </span>
                    </div>    
                <input class="form-control" type="text" id="m" autocomplete="off" style="width: 90%; display: inline-block"/>
                <button type="submit" class="btn btn-info">Send</button>
              </form>
            </div>              
            </main>
          </div>
        </div>
        <script>
            var map;
            var markers = [];
            var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';
            function setMapOnAll(map) {
              for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
              }
            }

            ///不要动
            var timeout = setInterval(reload, 5000);  
            
            function reload () {
              $(function() {
              var requestConfig = {
                  method: "GET",
                  url: "http://localhost:3000/mapdata",
                  };
                  $.ajax(requestConfig).then(function(result){
                    if(result!=null){
                      console.log(result);
                      let marker = new google.maps.Marker({
                        position: {lat: result.lat, lng: result.lng}
                      });
                      var j = 0;
                      for (let index = 0; index < markers.length; index++) {
                        if((result.lat != markers[index].getPosition().toJSON().lat) && (result.lng != markers[index].getPosition().toJSON().lng)){
                          j+=1;
                        }     
                      }
                      console.log(j);
                      if(j == markers.length){
                        markers.push(marker);
                        j = 0;
                      }
                      //markers.push(marker);
                      console.log(markers);
                  }
                  });
              });
              map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 40.744882, lng: -74.025343},
                zoom: 18
              });
              map.addListener('click', function(e) {
                var inf = prompt("Please enter the event here: ", "Meet me");
                placeMarkerAndPanTo(e.latLng, map, inf);
              });
              map.addListener('rightclick', function(e) {
                setMapOnAll(null);
                markers = [];
              });
              for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
              }
            }

            function initMap() {
              map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 40.744882, lng: -74.025343},
                zoom: 18
              });
              map.addListener('click', function(e) {
                var inf = prompt("Please enter the event here: ", "Meet me");
                placeMarkerAndPanTo(e.latLng, map, inf);
              });
              map.addListener('rightclick', function(e) {
                setMapOnAll(null);
                markers = [];
              });
            };
            ///不要动
      
            function placeMarkerAndPanTo(latLng, map, inf) {
              var marker2 = new google.maps.Marker({
                position: latLng,
                map: map,
                title: inf,
                icon: image,
                draggable: true,
              });
              markers.push(marker2);
              var cache = [];
              console.log(marker2.getPosition().toJSON().lat);
              $.ajax({
                type:"post",
                url: "http://localhost:3000/map",
                dataType: "json",
                data: JSON.stringify({
                  "lat": marker2.getPosition().toJSON().lat,
                  "lng": marker2.getPosition().toJSON().lng
                }),
                contentType:"application/json",
                success: function(data,textStatus, xhr){
                  if(!data.error){
                    alert("Edit successfully!");
                    location.reload(true);
                  // alert(xhr);
                  // if(xhr.status == 200){
                  //   alert("success");
                  //   location.reload(true);
                  }
                  else
                    alert("Server is busy! Try again later...")
                },
              });
              setMapOnAll(map);
            }
          </script>
          <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDH-oqwnk2ksa_mvMXm5AaqEgjhQWHhuxM&callback=initMap"
          async defer></script>
  </body>
</html>